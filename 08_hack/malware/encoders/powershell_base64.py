import base64

def escape_powershell_literal(cmd):
    # Sostituisci i caratteri speciali per Powershell, molto semplificato rispetto a Metasploit originale
    cmd = cmd.replace("'", "''")  # Escape singoli apici
    return cmd

def encode_powershell_base64(command):
    # Escapa la stringa come farebbe Metasploit
    escaped_command = escape_powershell_literal(command)
    # Prepara la stringa powershell
    ps_command = f"cmd.exe /c '{escaped_command}'"
    # Codifica in utf-16le come richiede powershell
    ps_bytes = ps_command.encode('utf-16le')
    # Codifica base64
    base64_command = base64.b64encode(ps_bytes).decode('ascii')
    # Ritorna la riga di comando completa pronta allâ€™uso
    return f"powershell -w hidden -nop -e {base64_command}"

# Esempio d'uso:
if __name__ == "__main__":
    command = "whoami"
    print(encode_powershell_base64(command))
